# Required Configuration

To succesfully run a kubernetes cluster in openstack, you will need to configure a few essential properties, then ensure that they are added to your machines.yaml file. The following components are necessary:
  - private network
  - public network
  - floating ip address
  - router connecting private network to public network
  - Specific security group rules
  - At least one of the supported operating system images

## Machines YAML

After running the `generate-yaml.sh`, the file `cmd/clusterctl/examples/openstack/out/machines.yaml` will be created at that location. This file stores information on what openstack elements to use to create the cluster on, and which cluster components to create. We provide you with a template to create one master and one worker node, however the template is incomplete and needs to be filled in. It looks like this:

[machine deployment template](../cmd/clusterctl/examples/openstack/machines.yaml.template)

## Private Network

Most openstack clusters come with a private network already, but if you would like to create a private network just for kubernetes, then the following openstack commands will create it, and a subnet for the nodes:

```bash
openstack network create <name of network>
openstack subnet create <name of subnet> --network <name of network> --subnet-range <CIDR ip range>
```

Once you have a network that you want to host the cluster on, you can add the id of that network to the config where it says `<Kubernetes Network ID>` in the ``machines.yaml`` file.

## Public Network

If your openstack cluster does not already have a public network, you should contact your cloud service provider. We will not review how to troubeshoot this here.

## Floating IP

Create a Floating IP via OpenStack for the master node before creating a cluster with the clusterctl tool. This IP will be used by ``clusterctl`` to access the master node via SSH to retrieve the kubeconfig file generated by kubeadm on the master node.

   For example, ``openstack floating ip create <public_net>`` to create a floating ip, e.g:

   ```bash
   +--------------------------------------+------------------+---------------------+---------+
   | id                                   | fixed_ip_address | floating_ip_address | port_id |
   +--------------------------------------+------------------+---------------------+---------+
   | aeefa79a-0e76-4c14-9da7-e5a9a6cc3787 |                  | 172.17.0.117        |         |
   +--------------------------------------+------------------+---------------------+---------+
   ```

Once you have an available floating ip, then you can add it to the `machines.yaml` script where it says `<Available Floating IP>`. You only need to create and use one floating ip.

## Proper Routing

Your kubernetes cluster must be reachable from wherever cluster-api-provider-openstack is being run from to set it up, and probably needs to be reachable by external trafic for use. To make your cluster reachable by external traffic, you will need to set up an openstack router that connects your private network to your public network. For this example, lets say you have a subnet named ``kube-nodes-subnet`` in the private network you created, and a public network named ``public`` that you are trying to connect with a router named ``kube-router``.

```bash
openstack router create kube-router
openstack router set kube-router --external-gateway public
openstack router add subnet kube-nodes-subnet
```

For another example on networking in openstack, look here https://developer.openstack.org/firstapp-libcloud/networking.html

## Security Group Rules

For the installer to work, a few security groups are required to be open. These may be different from the security groups needed to reach a cluster once its running. The following security group rules should be added to the security group of your chosing. For this example, we will suppose you created a security group names ``kubernetes`` that you will use for the cluster.

```bash
openstack security group rule create --ingress --protocol tcp --dst-port 6443 kubernetes
openstack security group rule create --ingress --protocol tcp --dst-port 22 kubernetes
openstack security group rule create --ingress --protocol tcp --dst-port 3000:32767 kubernetes
openstack security group rule create --ingress --protocol tcp --dst-port 443 kubernetes
openstack security group rule create --egress
```

## Security Groups
In machines.yaml, you can specify openstack security groups to be applied to each server in the `securityGroups` section of the YAML. You can specify the security group in 3 ways: by ID, by Name, or by filters. When you specify a security group by ID it will always return 1 security group or an error if it fails to find the security group specified. Please note that it is possible to add more than one security group to your machine when using Name or a Filter to specify it. The following filters are available to you:

  - TenantID
  - ProjectID
  - Limit
  - Marker
  - SortKey
  - SortDir
  - Tags
  - TagsAny
  - NotTags
  - NotTagsAny

Each security group can be specified by its uuid, its name, and a filter. It is recommended that you check to make sure that the name or filters you use return the security group or groups you are expecting using an openstack query. An example of the correct syntax for each of these use cases is below:

```yaml
securityGroups:
  - uuid: < your security group ID >
  - name: < your security group Name >
  - filter:
      project_id: < you project ID >
      tags: < a tag >
  - name: < your security group Name >
    filter:
      tags: < a tag >
```

## Operating System Images

We don't currently have specific version requriements, and so the choice is yours. However, we do require that you have either a ubuntu image or a centos image available in your cluster. For this step, we would like to refer you to the following doccumentation, https://docs.openstack.org/image-guide/obtain-images.html.

You can reference which operating system image you want to use in the machines.yaml script where it says `<Image Name>`. If you are using ubuntu, then replace `<SSH Username>` in machines.yaml with `ubuntu`. If you are using centos, then replace  `<SSH Username>` in machines.yaml with `centos`. 

## Subnets
Rather than just using a network, you have the option of specifying a specific subnet to connect your server to. The following is an example of how to specify a specific subnet of a network to use for a server.

```yaml
- apiVersion: "cluster.k8s.io/v1alpha1"
  kind: Machine
  metadata:
    generateName: openstack-node-
    labels:
      set: node
  spec:
    providerSpec:
      value:
        networks:
          - subnet_id: < subnet id >
```

## Network Filters
If you have a complex query that you want to use to lookup a network, then you can do this by using a network filter. The filter will allow you to look up a network by the following network features:
  - status
  - name
  - admin_state_up
  - tenant_id
  - project_id
  - shared
  - id
  - marker
  - limit
  - sort_key
  - sort_dir
  - tags
  - tags-any
  - not-tags
  - not-tags-any

By using filters to look up a network, please note that it is possible to get multiple networks as a result. This should not be a problem, however please test your filters with `openstack network list` to be certian that it returns the networks you want. Please refer to the following usage example:

```yaml
- apiVersion: "cluster.k8s.io/v1alpha1"
  kind: Machine
  metadata:
    generateName: openstack-node-
    labels:
      set: node
  spec:
    providerSpec:
      value:
        networks:
          - filters:
              name: myNetwork
              tags: myTag
```

## Multiple Networks
You can specify multiple networks (or subnets) to connect your server to. To do this, simply add another entry in the networks array. The following example connects the server to 3 different networks using all of the ways to connect discussed above:

```yaml
- apiVersion: "cluster.k8s.io/v1alpha1"
  kind: Machine
  metadata:
    generateName: openstack-node-
    labels:
      set: node
  spec:
    providerSpec:
      value:
        networks:
          - filters:
              name: myNetwork
              tags: myTag
          - uuid: your_network_id
          - subnet_id: your_subnet_id
```

## Tagging Instances
Tags can be added to instances on startup by populating the tags array where it says `<Your Tags>`. You can remove this if you do not want to tag your instances. Please note that your Nova api must be at least mivroversion 2.52 to use this api! Please refer to the following usage example:

```yaml
- apiVersion: "cluster.k8s.io/v1alpha1"
  kind: Machine
  metadata:
    generateName: openstack-node-
    labels:
      set: node
  spec:
    providerSpec:
      value:
        tags:
          - tag1
          - tag2
```

## Metadata
Instead of tagging, you also have the option to add metadata to instances. This functionality should be more commonly available than tagging. Here is a usage example:

```yaml
- apiVersion: "cluster.k8s.io/v1alpha1"
  kind: Machine
  metadata:
    generateName: openstack-node-
    labels:
      set: node
  spec:
    providerSpec:
      value:
        serverMetadata:
          name: bob
          nickname: bobbert
```

## Scheduler hints
OpenStack provides a way to define scheduler hints, which is useful to implement affinity/anti affinity. See [Nova Filter Scheduler](https://docs.openstack.org/nova/rocky/user/filter-scheduler.html) for more information.

```yaml
- apiVersion: "cluster.k8s.io/v1alpha1"
  kind: Machine
  metadata:
    generateName: openstack-node-
    labels:
      set: node
  spec:
    providerSpec:
      value:
        schedulerHints:
          group: uuid of server group
          differentHost:
          - UUID1
          - UUID2
          - ...
          sameHost:
          - ...
          query: |-
            ["and",
             [">=","$free_ram_mb","1024"],
             [">=","$free_disk_mb","2048"]]
```

Be aware, all of the hints depend on the setup of your cloud provider. So some filters might not work in your environment.


This example shows you how to build anti affinity for a `MachineDeployment`.

First you must create a [Server Group](https://docs.openstack.org/python-openstackclient/latest/cli/command-objects/server-group.html)
```
$ openstack server group create sg01 --policy anti-affinity
+--------------+------+------------+---------+-------------------+---------+----------+
| Id           | Name | Project Id | User Id | Policies          | Members | Metadata |
+--------------+------+------------+---------+-------------------+---------+----------+
| 54a88567-... | sg01 | ...        | ...     | ['anti-affinity'] | []      | {}       |
+--------------+------+------------+---------+-------------------+---------+----------+
```

You must reference this Server Group in the definition of your `MachineDeployment`

```yaml
apiVersion: cluster.k8s.io/v1alpha1
kind: MachineDeployment
metadata:
  labels:
    set: node
  name: test
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      set: node
      deployment: test
  template:
    metadata:
      labels:
        set: node
        deployment: test
    spec:
      providerSpec:
        value:
          apiVersion: openstackproviderconfig/v1alpha1
          availabilityZone: nova
          flavor: m1.micro
          image: Ubuntu 18.04 Bionic Beaver - Latest
          keyName: cluster-api-provider-openstack
          kind: OpenstackProviderSpec
          networks:
          - uuid: 964dc69d-3aef-473e-a500-18abc5b9b76f
          securityGroups:
          - uuid: f2c2ff1a-6049-42c7-99ff-06b9a04e56bd
          - uuid: 3108f6de-0785-4c23-b316-7d8c1b823b20
          sshUserName: ubuntu
          schedulerHints:
            group: 54a88567-20ae-467e-8210-3474e54ed168
          userDataSecret:
            name: worker-user-data
            namespace: openstack-provider-system
      versions:
        kubelet: 1.13.4
```

Be aware. The policy `anti-affinity` really means hard anti affinity. Thus, you can't create more VMs in a single Server Group than your cloud provider runs hypervisors in `availabilityZone`. All VMs that don't fit into the Server Group will land in `ERROR` state.

```
$ openstack server list
+--------------------------------------+-------------------------------+--------+---------------------------+-------------------------------------+-----------+
| ID                                   | Name                          | Status | Networks                  | Image                               | Flavor    |
+--------------------------------------+-------------------------------+--------+---------------------------+-------------------------------------+-----------+
| 34930b07-6c10-4b5b-98c9-eb42b044d02c | test-84bccdfb7b-4966r         | ERROR  |                           | Ubuntu 18.04 Bionic Beaver - Latest | m1.micro  |
+--------------------------------------+-------------------------------+--------+---------------------------+-------------------------------------+-----------+

$ openstack server show 34930b07-6c10-4b5b-98c9-eb42b044d02c
+-----------------------------+-------------------------------------------------------------------------------------------------------------------------------+
| Field                       | Value                                                                                                                         |
+-----------------------------+-------------------------------------------------------------------------------------------------------------------------------+
| fault                       | {'message': 'No valid host was found. There are not enough hosts available.', 'code': 500, 'created': '2019-03-25T15:43:20Z'} |
| status                      | ERROR                                                                                                                         |
| ...                         |                                                                                                                               |
+-----------------------------+-------------------------------------------------------------------------------------------------------------------------------+
```
